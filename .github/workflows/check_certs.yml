name: Check letsencrypt certificate expiry

on:
  # every sunday at 00:00
  schedule:
    - cron: "0 0 * * SUN"
  # or manually
  workflow_dispatch:

jobs:
  check-certs-expiry:
    name: Check letsencrypt certificate expiry
    runs-on: ubuntu-latest
    strategy:
      matrix:
        domain:
          - https://api.airt.ai
          - https://api.staging.airt.ai
    steps:
      - name: Check domain SSL and registry expire date
        id: check-domain
        uses: codex-team/action-check-domain@v1 # nosemgrep: yaml.github-actions.security.third-party-action-not-pinned-to-commit-sha.third-party-action-not-pinned-to-commit-sha
        with:
          url: ${{ matrix.domain }}

      - name: Create an issue if paid till number is below limit
        if: ${{ steps.check-domain.outputs.paid-till-days-left && steps.check-domain.outputs.paid-till-days-left < 5 }}
        uses: rishabhgupta/git-action-issue@v2 # nosemgrep: yaml.github-actions.security.third-party-action-not-pinned-to-commit-sha.third-party-action-not-pinned-to-commit-sha
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: ⚠️ ${{ matrix.domain }} — registry expiries in ${{ steps.check-domain.outputs.paid-till-days-left }} days
          body: 'Paid till: `${{ steps.check-domain.outputs.paid-till-date }}`'

      - name: Create an issue if SSL lifespan days number is below limit
        if: ${{ steps.check-domain.outputs.ssl-expire-days-left && steps.check-domain.outputs.ssl-expire-days-left < 5 }}
        uses: rishabhgupta/git-action-issue@v2 # nosemgrep: yaml.github-actions.security.third-party-action-not-pinned-to-commit-sha.third-party-action-not-pinned-to-commit-sha
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: 🧨 ${{ matrix.domain }} — SSL cert expires in ${{ steps.check-domain.outputs.ssl-expire-days-left }} days
          body: 'Valid till: `${{ steps.check-domain.outputs.ssl-expire-date }}`'
